name: Merge Lane

on:
  pull_request:
    types: [closed]
    branches:    
      - main

jobs:


  merge_and_export_lane:
    name: merge and export lane

    runs-on: ubuntu-latest

    env:
      BIT_TOKEN: ${{ secrets.BIT_TOKEN }}
      LANE_NAME: ${{ github.head_ref || github.ref_name }}

    container:
      image: docker://bitcli/bit:latest-node-16.15.0
    steps:
      - uses: teambit/setup-action@v2.02
        with:
          name: github-actions
          BIT_TOKEN: ${{ env.BIT_TOKEN }}
      - uses: actions/checkout@v3
        name: Checkout main branch
        with:
          ref: main

      - name: Merge changes from main to my lane
        run: bit lane merge main
      - name: Switch to Main Lane and checkout latest
        run: bit lane switch main
      - name: Merge Lane to Main
        run: bit lane merge $LANE_NAME

      - name: Install dependencies
        run: bit install

      - name: Tag merged components
        run: bit tag --message "${{ github.event.head_commit.message }}"
      - name: Export the Lane and the Components
        run: bit export
      - name: Clear .bitmap contents
        run: |
          rm -rf .bitmap
          bit init
      - name: empty .bitmap from pr
        uses: EndBug/add-and-commit@v9
        with:
          push: true
          message: 'remove .bitmap after merging'